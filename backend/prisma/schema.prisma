generator client {
  provider = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  STUDENT
  TEACHER
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  role         UserRole @default(STUDENT)

  projects     Project[]        @relation("ProjectOwner")
  assignments  JuryAssignment[] @relation("AssignmentEvaluator")
  
  ownedTeams   Team[]           @relation("TeamOwner")
  memberships  TeamMember[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([role])
}

model Project {
  id          String @id @default(cuid())
  title       String
  description String

  ownerId     String
  owner       User    @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  teamId      String?
  team        Team?   @relation(fields: [teamId], references: [id], onDelete: Cascade)

  deliverables Deliverable[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ownerId])
}

model Deliverable {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  title       String
  description String
  deadline    DateTime
  demoUrl     String?

  assignments JuryAssignment[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([deadline])
}

model JuryAssignment {
  id            String @id @default(cuid())
  deliverableId String
  deliverable   Deliverable @relation(fields: [deliverableId], references: [id], onDelete: Cascade)

  evaluatorId   String
  evaluator     User   @relation("AssignmentEvaluator", fields: [evaluatorId], references: [id], onDelete: Cascade)

  assignedAt    DateTime @default(now())
  expiresAt     DateTime

  grade         Grade?

  @@unique([deliverableId, evaluatorId])
  @@index([evaluatorId])
  @@index([deliverableId])
}

model Grade {
  id               String @id @default(cuid())
  juryAssignmentId String @unique
  assignment       JuryAssignment @relation(fields: [juryAssignmentId], references: [id], onDelete: Cascade)

  score            Decimal @db.Decimal(4, 2)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Team {
  id          String   @id @default(cuid())
  name        String
  description String
  
  ownerId     String
  owner       User     @relation("TeamOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  
  members     TeamMember[]
  projects    Project[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TeamMember {
  id        String   @id @default(cuid())
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  joinedAt  DateTime @default(now())
  
  @@unique([teamId, userId])
}
