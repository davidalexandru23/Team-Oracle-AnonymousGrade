generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  STUDENT
  TEACHER
}

model User {
  id           String   @id @default(cuid())
  name         String
  email        String   @unique
  passwordHash String
  role         UserRole @default(STUDENT)

  projects     Project[]        @relation("ProjectOwner")
  assignments  JuryAssignment[] @relation("AssignmentEvaluator")

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([role])
}

model Project {
  id          String @id @default(cuid())
  title       String
  description String

  ownerId     String
  owner       User    @relation("ProjectOwner", fields: [ownerId], references: [id], onDelete: Cascade)

  deliverables Deliverable[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ownerId])
}

model Deliverable {
  id          String   @id @default(cuid())
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  title       String
  description String
  deadline    DateTime
  demoUrl     String?

  assignments JuryAssignment[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([projectId])
  @@index([deadline])
}

model JuryAssignment {
  id            String @id @default(cuid())
  deliverableId String
  deliverable   Deliverable @relation(fields: [deliverableId], references: [id], onDelete: Cascade)

  evaluatorId   String
  evaluator     User   @relation("AssignmentEvaluator", fields: [evaluatorId], references: [id], onDelete: Cascade)

  assignedAt    DateTime @default(now())
  expiresAt     DateTime

  grade         Grade?

  @@unique([deliverableId, evaluatorId])
  @@index([evaluatorId])
  @@index([deliverableId])
}

model Grade {
  id               String @id @default(cuid())
  juryAssignmentId String @unique
  assignment       JuryAssignment @relation(fields: [juryAssignmentId], references: [id], onDelete: Cascade)

  score            Decimal @db.Decimal(4, 2)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}
